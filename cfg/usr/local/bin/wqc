#!/usr/bin/env bash
#
# iwctl alias
set -e

usage() {
  echo "usage: ${0##*/} [-h] -i INAME -n SSID"
  echo
  echo 'iwctl alias'
  echo
  echo 'options:'
  echo '  -h        show this help message and exit'
  echo '  -i INAME  specify interface name'
  echo '  -n SSID   specify a SSID'

  exit "${1}"
}

check_command() {
  local command="${1}"
  if ! command -v "${command}" > /dev/null; then
    echo "! ${command} command missing" >&2
    exit 1
  fi
}

main() {
  local OPTARG
  local arg

  check_command iwctl

  if (($(id -u) != 0)); then
    echo '! Run this script as root'
    exit 1
  fi

  # Parse args
  ((${#} == 0)) && usage 1 >&2
  while getopts 'hi:n:' arg; do
    case "${arg}" in
      i) local iname="${OPTARG}" ;;
      n) local ssid="${OPTARG}" ;;
      h) usage 0 ;;
      *) usage 1 >&2 ;;
    esac
  done

  local password
  local password="$(systemd-ask-password --echo=no --emoji=no)"

  iwctl --passphrase "${password}" station "${iname}" connect "${ssid}"
  # Remove clear text password
  sed -i '/^Passphrase=./d' "/var/lib/iwd/${ssid}.psk"

  systemctl enable --now iwd
  systemctl restart systemd-networkd
}

main "${@}"
